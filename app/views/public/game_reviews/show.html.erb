<div class="row mt-4 pb-4 border-bottom">
  <h2 class="text-center">ゲームレビュー詳細</h2>
</div>

<div class="row mt-5 justify-content-center border-bottom">
  <div class="col-6 pb-5">
    <table class="table table-borderless">
      <tr>
        <th>タイトル</th>
        <td>
          <%= @game_review.game_title %>
        </td>
      </tr>

      <tr>
        <th>概要</th>
        <td>
          <%= @game_review.game_summary %>
        </td>
      </tr>

      <tr>
        <th>ジャンル</th>
        <td>
          <%= @game_review.genre.genre_name %>
        </td>
      </tr>

      <tr>
        <th>タグ</th>
        <td>
          <% @game_tags.each do |game_tag| %>
            <%= game_tag.game_tag_name %>
          <% end %>
        </td>
      </tr>

      <tr>
        <th>感想</th>
        <td>
          <%= @game_review.game_impression %>
        </td>
      </tr>

      <tr>
        <th>￥</th>
        <td>
          <%= @game_review.game_price.to_s(:delimited) %>
        </td>
      </tr>

      <tr>
        <th>評価</th>
        <td>
          <div id="review_display<%= @game_review.id %>">
          </div>
          <%= render "review_display", game_review: @game_review %>
        </td>
      </tr>
    </table>

    <div class="row d-flex justify-content-evenly">
      <% if !Group.exists?(game_review_id: @game_review.id) && current_member.id == @game_review.member.id %>
        <button class="actions col-3 mt-4 btn btn-info btn-lg" data-bs-toggle="modal" data-bs-target="#groupCreate">
          <a class="fw-bold text-light">グループ作成</a>
        </button>
      <% elsif Group.exists?(game_review_id: @game_review.id) && current_member.id == @game_review.member.id %>
        <button class="col-3 mt-4 btn btn-outline-dark btn-lg" disabled>
          <a class="fw-bold">グループ作成済み</a>
        </button>
      <% elsif Group.exists?(game_review_id: @game_review.id) && current_member.id != @game_review.member.id && !GroupMember.exists?(member_id: current_member.id, group_id: @game_review.group.id) %>
        <button class="actions col-3 mt-4 btn btn-info btn-lg text-light">
          <%= link_to group_group_members_path(@game_review.group), method: :post, class:"text-light fw-bold" do %>
            グループへ参加
          <% end %>
        </button>
      <% elsif Group.exists?(game_review_id: @game_review.id) && current_member.id != @game_review.member.id %>
        <button class="col-3 mt-4 btn btn-outline-dark btn-lg" disabled>
          <a class="fw-bold">グループ参加済み</a>
        </button>
      <% else %>
        <button class="col-3 mt-4 btn btn-outline-dark btn-lg" disabled>
          <a class="fw-bold">グループ未作成</a>
        </button>
      <% end %>

      <div class="modal fade" id="groupCreate">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">グループ作成</h5>
              <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <%= form_with model: @group, url: groups_path do |f| %>
              <div class="modal-body">
                <div class="mt-3">
                  <%= f.text_field :group_name, autofocus: true, placeholder: "グループネーム", class:"form-control" %>
                </div>

                <div class="mt-3 pb-3">
                  <%= f.text_field :group_introduction, placeholder: "グループ紹介文", class:"form-control" %>
                </div>
                <%= f.hidden_field :game_review_id, value: @game_review.id %>
                <%= f.hidden_field :group_owner_id, value: current_member.id %>
              </div>

              <div class="modal-footer">
                <div class="me-auto">
                  <%= f.submit "グループ作成", class:"btn btn-info text-light" %>
                </div>

                <div>
                  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="col-2 mt-4 text-center">
        <% if @game_review.game_likes?(current_member) %>
          <%= link_to game_review_game_like_path(@game_review.id), method: :delete do %>
            <i class="fa-solid fa-heart fa-3x"></i>
          <% end %>
        <% else %>
          <%= link_to game_review_game_likes_path(@game_review.id), method: :post do %>
            <i class="fa-regular fa-heart fa-3x"></i>
          <% end %>
        <% end %>
      </div>

      <button class="actions col-2 mt-4 btn btn btn-danger btn-lg">
        <%= link_to "削除", game_review_path(@game_review), method: :delete, class:"text-light fw-bold" %>
      </button>
    </div>
  </div>
</div>

<div class="row mt-5 justify-content-center">
  <div class="col-7 pb-5 border-bottom">
    <%= form_with model: @game_comment, url: @game_comment.id.nil? ? game_review_game_comments_path(game_review_id: @game_review) : game_review_game_comment_path(@game_comment, game_review_id: @game_review) do |f| %>
      <div class="input-group d-flex justify-content-center">
        <div class="col-10 text-wrap">
          <%= f.text_field :game_comment, placeholder: "コメントを送信", class:"form-control form-control-sm" %>
        </div>

        <% if @game_comment.id.nil? %>
          <div>
            <%= button_tag method: :post do %>
              <i class="fa-solid fa-square-caret-down"></i>
            <% end %>
          </div>
        <% else %>
          <div>
            <%= button_tag method: :patch do %>
              <i class="fa-solid fa-square-caret-down"></i>
            <% end %>
          </div>
        <% end %>
      </div>

      <% unless @game_comment.id.nil? %>
        <div class="col-3 offset-1">
          <%= link_to "キャンセル", game_review_path(@game_review), class:"link-dark" %>
        </div>
      <% end %>
    <% end %>

    <table class="mt-3 table table-borderless">
      <% @game_comments.each do |game_comment| %>
        <tr>
          <td><%= image_tag game_comment.member.get_profile_image(50, 50) %></td>

          <td class="text-break">
            <%= game_comment.member.member_name %><br>
            <%= game_comment.game_comment %>
          </td>

          <td>
            <div class="dropend">
              <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              </button>

              <ul class="dropdown-menu">
                <li class="text-center">
                  <a class="dropdown-item">
                    <%= link_to "編集", game_review_path(@game_review, game_comment_id: game_comment), class:"link-dark" %>
                  </a>
                </li>

                <li class="text-center">
                  <a class="dropdown-item">
                    <%= link_to "削除", game_review_game_comment_path(@game_review, game_comment), method: :delete, class:"link-dark" %>
                  </a>
                </li>
              </ul>
            </div>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
</div>